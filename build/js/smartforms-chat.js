(()=>{"use strict";function e(e,t){e.firstElementChild&&e.firstElementChild.remove(),e.insertBefore(t,e.firstElementChild)}const t=function(){const e=document.getElementById("smartforms-config");if(e)try{return JSON.parse(e.textContent)}catch(e){return console.error("Error parsing smartforms configuration:",e),null}return null}()||{formData:null,ajaxUrl:"",nonce:"",formId:null};document.addEventListener("DOMContentLoaded",(()=>{const{formData:r,ajaxUrl:a,nonce:s,formId:n}=t;if(!r||!r.fields||0===r.fields.length)return void console.error("No form data available for SmartForms chat flow.");let o=0;const l={};let c=null;const i=document.getElementById("smartforms-chat-dialog"),m=document.getElementById("smartforms-chat-submit-button"),d=document.getElementById("smartforms-chat-input-box"),u=document.getElementById("smartforms-chat-help-container");function p(e,t){const r=document.createElement("div");r.classList.add("smartforms-chat-message",t);const a=document.createElement("p");a.textContent=e,r.appendChild(a),i.appendChild(r),i.scrollTop=i.scrollHeight}function f(e,t){if(!e.required)return m.classList.remove("disabled"),void("buttons"===e.type&&(c=t));"buttons"===e.type&&(c=t),null===t||"string"==typeof t&&""===t.trim()||Array.isArray(t)&&0===t.length?m.classList.add("disabled"):m.classList.remove("disabled")}function h(){const t=r.fields[o];c=null,p(t.label,"bot");const a=function(e,t){let r;switch(e.type){case"text":r=document.createElement("input"),r.type="text",r.className="form-control smartforms-text-input",r.placeholder=e.placeholder||"Type your answer here...",e.id||(r.id="smartforms-current-input"),r.addEventListener("input",(r=>{t(e,r.target.value)}));break;case"number":r=document.createElement("input"),r.type="number",r.className="form-control smartforms-number",r.placeholder=e.placeholder||"",e.id||(r.id="smartforms-current-input"),r.addEventListener("input",(r=>{t(e,r.target.value)}));break;case"slider":r=document.createElement("input"),r.type="range",r.className="form-control smartforms-slider",r.min=e.min||0,r.max=e.max||100,r.value=e.value||Math.floor(((e.min||0)+(e.max||100))/2),e.id||(r.id="smartforms-current-input"),r.addEventListener("input",(r=>{t(e,r.target.value)}));break;case"textarea":default:r=document.createElement("textarea"),r.className="form-control smartforms-textarea smartforms-chat-input",r.rows=4,r.placeholder=e.placeholder||"Type your answer here...",e.id||(r.id="smartforms-current-input"),r.addEventListener("input",(r=>{t(e,r.target.value)}));break;case"select":r=document.createElement("select"),r.className="form-control smartforms-select",e.id||(r.id="smartforms-current-input"),e.options&&Array.isArray(e.options)&&e.options.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,r.appendChild(t)})),r.addEventListener("change",(r=>{t(e,r.target.value)}));break;case"checkbox":r=document.createElement("div"),r.className="sf-checkbox-group sf-checkbox-group-"+(e.layout||"horizontal"),r.setAttribute("data-layout",e.layout||"horizontal"),e.options&&Array.isArray(e.options)&&e.options.forEach((a=>{const s=document.createElement("div"),n="horizontal"===e.layout?" form-check-inline":"";s.className="sf-checkbox-option form-check"+n;const o=document.createElement("input");o.type="checkbox",o.className="form-check-input",o.value=a.value,o.id=e.id?`${e.id}-${a.value}`:a.value;const l=document.createElement("label");l.className="form-check-label",l.htmlFor=o.id,l.textContent=a.label,s.appendChild(o),s.appendChild(l),r.appendChild(s),o.addEventListener("change",(()=>{const a=Array.from(r.querySelectorAll("input[type='checkbox']")).filter((e=>e.checked)).map((e=>e.value));t(e,a)}))}));break;case"buttons":r=document.createElement("div"),r.className="sf-buttons-group d-flex flex-wrap gap-2",e.options&&Array.isArray(e.options)&&e.options.forEach((a=>{const s=document.createElement("button");s.type="button",s.className="btn btn-primary",s.setAttribute("data-value",a.value),s.textContent=a.label,s.addEventListener("click",(()=>{if(e.multiple){s.classList.toggle("active");const a=Array.from(r.querySelectorAll("button.active")).map((e=>e.getAttribute("data-value")));t(e,a)}else Array.from(r.children).forEach((e=>e.classList.remove("active"))),s.classList.contains("active")?(s.classList.remove("active"),t(e,null)):(s.classList.add("active"),t(e,a.value))})),r.appendChild(s)}))}return r}(t,f);e(d,a),f(t,c)}h(),f(r.fields[o],c),m.addEventListener("click",(t=>{t.preventDefault();const f=r.fields[o];if(f.required&&m.classList.contains("disabled"))return u.textContent=f.requiredMessage||`${f.label} is required.`,u.classList.add("smartforms-error-message"),void setTimeout((()=>{u.textContent=f.helpText||"Enter your help text",u.classList.remove("smartforms-error-message")}),3e3);let y;if("buttons"===f.type)y=c;else if("checkbox"===f.type){const e=d.querySelectorAll("input[type='checkbox']");y=Array.from(e).filter((e=>e.checked)).map((e=>e.value)).join(", ")}else if("text"===f.type){const e=d.querySelector("input");if(!e)return;y=e.value}else{const e=d.firstElementChild;if(!e)return;y=e.value}!function(t,f=t){const y=r.fields[o];if(y.required&&("string"==typeof t&&""===t.trim()||Array.isArray(t)&&0===t.length||null===t))return u.textContent=y.requiredMessage||`${y.label} is required.`,u.classList.add("smartforms-error-message"),void setTimeout((()=>{u.textContent=y.helpText||"Enter your help text",u.classList.remove("smartforms-error-message")}),3e3);if(p(f,"user"),u.textContent=y.helpText||"Enter your help text",u.classList.remove("smartforms-error-message"),l[y.id||o]=t,c=null,o<r.fields.length-1)o++,h();else{const t=new URLSearchParams;t.append("action","process_smartform"),t.append("smartform_nonce",s),t.append("form_id",n),t.append("form_data",JSON.stringify(l)),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}).then((e=>e.json())).then((t=>{i.innerHTML="";const r=document.createElement("div");if(r.classList.add("smartforms-chat-message","bot"),t.success)r.innerHTML=`<p>${t.data.message}</p>`;else{const e=Array.isArray(t.data)?t.data.join(" "):t.data;r.innerHTML=`<p class="error">${e}</p>`}i.appendChild(r),i.scrollTop=i.scrollHeight;const a=document.createElement("textarea");a.className="form-control smartforms-chat-input",a.rows=4,a.placeholder="Type your message here...",a.disabled=!0,e(d,a),m.classList.add("disabled")})).catch((e=>{console.error("AJAX submission error:",e)}))}}(y)}))}))})();